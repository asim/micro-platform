<div>
  <mat-spinner
    [diameter]="70"
    style="margin: auto;"
    *ngIf="!services"
  ></mat-spinner>
</div>
<div *ngIf="services" style="margin: auto;">
  <mat-card style="margin-top: 0em; padding-top: 0em;" class="mat-card-flat">
    <mat-card-title
      fxLayout="row"
      fxLayout.lt-md="column"
      style="align-items: center;"
    >
      <div>
        <a routerLink="/services"
          >services <span fxHide.lt-md>&gt; &nbsp;</span></a
        >
      </div>
      <div>
        <mat-icon style="color: green; vertical-align: middle;"
          >fiber_manual_record</mat-icon
        >
        &nbsp;{{ serviceName }} &nbsp;
      </div>
      <div>
        <!-- The ngStyle background color is a horrible hack due to mat-chips not
        supporting dynamically the selected property. -->
        <mat-chip-list selectable="false" aria-label="Versions">
          <mat-chip
            selectable="false"
            (click)="versionSelected(service)"
            *ngFor="let service of services"
            [ngStyle]="
              selectedVersion == service.version && {
                'background-color': '#673ab7',
                color: 'white'
              }
            "
            >{{ service.version }}</mat-chip
          >
        </mat-chip-list>
      </div>
    </mat-card-title>

    <mat-tab-group
      animationDuration="0ms"
      [selectedIndex]="selected"
      (selectedIndexChange)="tabChange($event)"
    >
      <mat-tab style="padding-top: 1em;" label="Endpoints">
        <br />
        <form style="margin-left: 1.5em;" class="example-form">
          <mat-form-field class="example-full-width">
            <input
              name="query"
              matInput
              [(ngModel)]="endpointQuery"
              placeholder="Search endpoints"
            />
          </mat-form-field>
        </form>
        <ng-container *ngFor="let service of pickVersion(services)">
          <div
            *ngFor="
              let endpoint of service.endpoints | search: 'name':endpointQuery
            "
          >
            <div>
              <mat-expansion-panel class="mat-elevation-z0">
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    {{ endpoint.name }}
                  </mat-panel-title>
                  <mat-panel-description>
                    {{ endpoint.title }}
                  </mat-panel-description>
                </mat-expansion-panel-header>
                <mat-tab-group animationDuration="0ms">
                  <mat-tab label="Definition">
                    <ng-template matTabContent>
                      <br />
                      <pre style="padding: 1em; background: #f6f6f6;">{{
                        valueToString(endpoint.request, 1)
                      }}</pre>
                      <br />
                      <pre style="padding: 1em; background: #f6f6f6;">{{
                        valueToString(endpoint.response, 1)
                      }}</pre>
                    </ng-template>
                  </mat-tab>
                  <mat-tab label="Call">
                    <ng-template matTabContent>
                      <br />
                      <div
                        fxLayout.lt-md="column"
                        fxLayout="row"
                        fxLayoutGap="1em"
                      >
                        <div fxFlex="calc(50% - 0.5em)">
                          Request<br /><br />
                          <ngx-monaco-editor
                            style="height: 25em"
                            [options]="coptions"
                            [(ngModel)]="endpoint.requestJSON"
                          ></ngx-monaco-editor>
                        </div>
                        <div fxFlex="calc(50% - 0.5em)">
                          Response<br /><br />
                          <ngx-monaco-editor
                            style="height: 25em"
                            [options]="coptions"
                            [(ngModel)]="endpoint.responseJSON"
                          ></ngx-monaco-editor>
                        </div>
                      </div>
                      <br />
                      <button
                        mat-raised-button
                        (click)="callEndpoint(service, endpoint)"
                        color="primary"
                      >
                        Call
                      </button>
                    </ng-template>
                  </mat-tab>
                </mat-tab-group>
              </mat-expansion-panel>
            </div>
            <br />
          </div>
        </ng-container>
      </mat-tab>
      <mat-tab label="Logs">
        <pre>
            <div *ngFor="let log of logs">{{ log.message }}</div></pre>
      </mat-tab>
      <mat-tab label="Stats">
        <ng-template matTabContent>
          <br />
          <div style="text-align: center">
            <mat-checkbox class="example-margin" [(ngModel)]="refresh"
              >Refresh</mat-checkbox
            >
          </div>
          <br />
          <app-stat-charts [stats]="stats"></app-stat-charts>
        </ng-template>
      </mat-tab>
      <mat-tab label="Nodes">
        <br />
        <ng-template matTabContent>
          <br />
          <div fxLayout="row">
            <div style="width: 50%">
              <b style="font-weight: 700;">Name</b>
            </div>
            <div style="width: 50%">
              <b style="font-weight: 700;">Address</b>
            </div>
          </div>
          <br />
          <ng-container *ngFor="let node of services[0].nodes">
            <div fxLayout="row">
              <div style="width: 50%">
                {{ node.id }}
              </div>
              <div style="width: 50%">
                {{ node.address }}
              </div>
            </div>
            <div style="width: 100%; padding-top: 1em; margin-bottom: 1em;">
              <pre style="padding: 1em; background: #f3f3f3;">{{
                metadata(node)
              }}</pre>
            </div>
          </ng-container>
        </ng-template>
      </mat-tab>
      <mat-tab label="Trace">
        <ng-template matTabContent>
          <br />
          <app-trace-list
            [serviceName]="services[0].name"
            [spans]="traceSpans"
          ></app-trace-list>
        </ng-template>
      </mat-tab>
    </mat-tab-group>
  </mat-card>
</div>
